# AZR Data Management and Automation Tools

This directory contains utilities to automate AZR training data management and completion detection.

## Scripts Overview

### 1. `merge_parquet_data.py`
Merges newly generated Parquet files from checkpoint directory with existing training data.

**Usage:**
```bash
# Basic merge
python merge_parquet_data.py --checkpoint-dir checkpoints/code_io/azr/0.5b_coder_seed_generation/test_answer/Qwen2.5-Coder-0.5B/answer_conditional/code/ --output-dir data/code_reason/

# With backup
python merge_parquet_data.py --checkpoint-dir <checkpoint_dir> --output-dir <output_dir> --backup

# Dry run to see what would be merged
python merge_parquet_data.py --checkpoint-dir <checkpoint_dir> --output-dir <output_dir> --dry-run
```

### 2. `training_monitor.py`
Monitors AZR training progress and automatically stops when no new data is generated.

**Usage:**
```bash
# Monitor with auto-stop and auto-merge
python training_monitor.py --checkpoint-dir <checkpoint_dir> --output-dir <output_dir>

# Monitor specific training process
python training_monitor.py --checkpoint-dir <checkpoint_dir> --training-pid <PID>

# Custom thresholds
python training_monitor.py --checkpoint-dir <checkpoint_dir> --stagnation-threshold 3600 --check-interval 600
```

### 3. `automated_pipeline.py`
Complete automated training pipeline that integrates data merging and completion detection.

**Usage:**
```bash
# Full automated pipeline
python automated_pipeline.py --azr-dir /path/to/Absolute-Zero-Reasoner

# With custom settings
python automated_pipeline.py --azr-dir <azr_dir> --checkpoint-dir <checkpoint_dir> --data-dir <data_dir>

# Skip pre/post merge steps
python automated_pipeline.py --azr-dir <azr_dir> --no-pre-merge --no-post-merge
```

## Quick Start for AZR Project

Based on your current setup:

1. **Copy scripts to AZR project:**
```bash
cp -r /path/to/azr-data-utils /home/frankshortt/AI/qwen3-training/Absolute-Zero-Reasoner/
```

2. **Run immediate data merge:**
```bash
cd /home/frankshortt/AI/qwen3-training/Absolute-Zero-Reasoner
python azr-data-utils/merge_parquet_data.py \
  --checkpoint-dir checkpoints/code_io/azr/0.5b_coder_seed_generation/test_answer/Qwen2.5-Coder-0.5B/answer_conditional/code/ \
  --output-dir data/code_reason/ \
  --backup
```

3. **Run training with automated completion:**
```bash
python azr-data-utils/automated_pipeline.py --azr-dir .
```

## Current AZR Status

According to memory:
- **Generated Data:** 7063+ new training examples (27x increase)
- **Current Issue:** Training reads from `data/code_reason/test_answer.parquet` but new data is in checkpoint folder
- **Solution:** Use `merge_parquet_data.py` to consolidate data

## Files Generated by AZR Training

The training generates these Parquet files:
- `train_gen_code_f.parquet` (7063 lines)
- `train_gen_code_i.parquet` (605 lines) 
- `train_gen_code_o.parquet` (621 lines)
- `train_pred_code_f.parquet`
- `train_pred_code_i.parquet`
- `train_pred_code_o.parquet`

## Configuration

### Training Monitor Settings
- **Check Interval:** 300s (5 minutes)
- **Stagnation Threshold:** 1800s (30 minutes)
- **Minimum New Samples:** 10 samples to consider training active

### Data Merger Features
- Automatic backup creation
- Duplicate detection and removal
- Supports multiple Parquet file types
- Combines all data into single `test_answer.parquet`

## Troubleshooting

### Common Issues

1. **Permission errors:** Ensure scripts have execute permissions
2. **Path issues:** Use absolute paths for WSL environments
3. **Process detection:** Training monitor looks for `main_azr_ppo.py` process
4. **Memory issues:** Monitor RAM usage during data merging with large datasets

### Logs

All scripts use Python logging. Use `--help` on any script for detailed options.

## Integration with Existing AZR Code

To modify the main AZR training script for automatic completion:

1. **Add early stopping logic** in the main training loop
2. **Monitor data generation rate** and stop when threshold is reached
3. **Automatically merge data** after training completes

The automated pipeline handles this without modifying the core AZR code.
